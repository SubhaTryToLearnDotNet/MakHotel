@using MakQR.Models.Admin
@model ChangePasswordModel
<div class="admin-page">
    <div class="hotel-form-card">

        <h3>Change Password</h3>

        <form id="PasswordForm">

            <!-- Old Password -->
            <div class="mb-3">
                <label>Old Password</label>
                <div class="input-group">
                    <input type="password"
                           asp-for="OldPassword"
                           id="OldPassword"
                           class="form-control">

                    <button type="button"
                            class="btn btn-outline-secondary"
                            onclick="togglePassword('OldPassword', this)">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="OldPassword" class="text-danger"></span>
            </div>


            <!-- New Password -->
            <div class="mb-3">
                <label>New Password</label>
                <div class="input-group">
                    <input type="password"
                           asp-for="NewPassword"
                           id="NewPassword"
                           class="form-control">

                    <button type="button"
                            class="btn btn-outline-secondary"
                            onclick="togglePassword('NewPassword', this)">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="NewPassword" class="text-danger"></span>
            </div>


            <!-- Confirm Password -->
            <div class="mb-3">
                <label>Confirm Password</label>
                <div class="input-group">
                    <input type="password"
                           asp-for="ConfirmPassword"
                           id="ConfirmPassword"
                           class="form-control">

                    <button type="button"
                            class="btn btn-outline-secondary"
                            onclick="togglePassword('ConfirmPassword', this)">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
            </div>


            <button type="submit"
                    id="submitBtn"
                    class="btn btn-success"
                    disabled>
                Update Password
            </button>

        </form>

    </div>
</div>
@section Scripts {

    <partial name="_ValidationScriptsPartial" />

    <script>
        const form = document.getElementById("PasswordForm");
        const submitBtn = document.getElementById("submitBtn");
        const newPass = document.getElementById("NewPassword");
        const confirmPass = document.getElementById("ConfirmPassword");
                function togglePassword(fieldId, button) {

            const input = document.getElementById(fieldId);
            const icon = button.querySelector("i");

            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }


        function checkPasswordMatch() {

            if (
                newPass.value !== "" &&
                confirmPass.value !== "" &&
                newPass.value === confirmPass.value
            ) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        newPass.addEventListener("keyup", checkPasswordMatch);
        confirmPass.addEventListener("keyup", checkPasswordMatch);


        form.addEventListener("submit", async function (e) {

            e.preventDefault();

            submitBtn.disabled = true;

            Swal.fire({
                title: 'Updating...',
                text: 'Please wait',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const data = {
                OldPassword: document.getElementById("OldPassword").value,
                NewPassword: newPass.value,
                ConfirmPassword: confirmPass.value
            };

            try {

                const response = await fetch('/Admin/UpdatePassword', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {

                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: result.message
                    }).then(() => {
                        window.location.reload();
                    });

                } else {

                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: result.message
                    });

                    submitBtn.disabled = false;
                }

            } catch (err) {

                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong'
                });

                submitBtn.disabled = false;
            }

        });
    </script>

}
